<html>
<canvas id="myCanvas" width="1024" height="768"></canvas>

<script src="https://cdnjs.cloudflare.com/ajax/libs/engine.io-client/3.4.3/engine.io.min.js"></script>

<script>
  const SCREEN_WIDTH = 1024;
  const SCREEN_HEIGHT = 768;
  const SCREEN_MIDDLE_X = SCREEN_WIDTH / 2;
  const SCREEN_MIDDLE_Y = SCREEN_HEIGHT / 2;

  var players = [{xPos: 10, yPos: 20}, {xPos: 100, yPos: 200}];
  var obstacles = [{xPos: 10, yPos: 20}, {xPos: 100, yPos: 200}]
  var myId = 123;
  var angle = 0;

  const socket = eio('ws://localhost:1738', {path: '/engine.io/game'});
  socket.on('open', () => {
    console.log('socket opened');
    socket.send(JSON.stringify({type: 'playerjoin', id: 123, name: 'john xi-na'}));
    socket.on('message', (data) => {
      const jsonData = JSON.parse(data);
      players = jsonData.players;
    });
    socket.on('close', () => {});
  });

  function onMouseMove(event) {
    var rect = myCanvas.getBoundingClientRect();

    mouseX = (event.clientX - rect.left) - SCREEN_MIDDLE_X;
    mouseY = (event.clientY - rect.top) - SCREEN_MIDDLE_Y;
    mouseY *= -1;

    if (mouseX == 0 && mouseY < 0) {
      angle = 0;
    } else if (mouseX == 0 && mouseY > 0) {
      angle = 180;
    } else if (!(mouseX == 0 && mouseY == 0)) {
      angle = Math.atan(mouseY / mouseX) * 180 / Math.PI;
      if (mouseX < 0) {
        angle += 180;
      }
    }
    if (angle < 0) {
      angle = 360 + angle;
    }

    socket.send(JSON.stringify({type: 'updateplayer', id: 123, angle: angle}));
  }

  window.addEventListener("mousemove", onMouseMove, false);

  function draw() {
    window.requestAnimationFrame(draw);
    var canvas = document.getElementById('myCanvas');
    var ctx = canvas.getContext('2d');

    // Clear screen before redrawing.
    ctx.clearRect(0, 0, canvas.width, canvas.height);

    var myX;
    var myY;

    for (const player of players) {
      if (player.id == myId) {
        myX = player.xPos;
        myY = player.yPos;
        break;
      }
    }

    for (const player of players) {
      drawCircle(ctx, player.xPos - myX + SCREEN_MIDDLE_X, player.yPos - myY + SCREEN_MIDDLE_Y, 10);
    }
    for (const obstacle of obstacles) {
      drawCircle(ctx, obstacle.xPos - myX + SCREEN_MIDDLE_X, obstacle.yPos - myY + SCREEN_MIDDLE_Y, 10, ' blue');
    }
  }

  function drawCircle(ctx, x, y, r, color='#b8e015') {
      ctx.beginPath();
      ctx.arc(x, y, r, 0, Math.PI*2);
      ctx.fillStyle = color;
      ctx.fill();
      ctx.closePath();
  }

  draw();
</script>
</html>